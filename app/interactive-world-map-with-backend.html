<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Интерактивная карта мира</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a5f7a;
            min-height: 100vh;
            overflow: hidden;
        }

        .language-switcher {
            position: fixed;
            top: 30px;
            left: 30px;
            z-index: 1000;
            background: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }

        .language-switcher:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        }

        .profile-icon {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 1000;
            background: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            color: #2c3e50;
        }

        .profile-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        }

        .profile-icon svg {
            width: 32px;
            height: 32px;
            fill: #2c3e50;
        }

        .map-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            transition: filter 0.3s ease;
        }

        .map-container.blurred {
            filter: blur(8px);
        }

        #worldMap {
            width: 100%;
            height: 100%;
        }

        .country-path {
            stroke: #2c3e50;
            stroke-width: 0.5;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .country-path:hover {
            filter: brightness(1.3) drop-shadow(0 8px 15px rgba(0,0,0,0.5));
            stroke: #fff;
            stroke-width: 2;
        }

        .country-label {
            font-size: 10px;
            font-weight: 600;
            fill: rgba(0, 0, 0, 0.8);
            pointer-events: none;
            text-anchor: middle;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.9);
        }

        .info-panel {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: white;
            padding: 25px 35px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
            max-width: 350px;
            z-index: 999;
        }

        .info-panel.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .info-panel h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .info-panel p {
            color: #555;
            font-size: 15px;
            line-height: 1.6;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            z-index: 1001;
        }

        .zoom-controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .zoom-btn {
            width: 50px;
            height: 50px;
            background: white;
            border: none;
            border-radius: 10px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #2c3e50;
        }

        .zoom-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            background: #f0f0f0;
        }

        .zoom-btn:active {
            transform: scale(0.95);
        }

        /* Модальное окно профиля */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .profile-modal.show {
            display: flex;
            opacity: 1;
        }

        .profile-modal-content {
            background: white;
            width: 50%;
            max-width: 600px;
            min-width: 400px;
            border-radius: 20px;
            padding: 50px 60px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .profile-modal.show .profile-modal-content {
            transform: translateY(0);
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 32px;
            color: #888;
            cursor: pointer;
            transition: color 0.3s ease;
            background: none;
            border: none;
            line-height: 1;
        }

        .close-modal:hover {
            color: #333;
        }

        .form-header {
            margin-bottom: 40px;
            text-align: center;
        }

        .form-header h2 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            display: inline-block;
            position: relative;
        }

        .form-header h2:hover {
            color: #4ECDC4;
            transform: scale(1.05);
        }

        .form-header h2::after {
            content: '⇄';
            font-size: 20px;
            margin-left: 12px;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .form-header h2:hover::after {
            opacity: 1;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            color: #555;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            outline: none;
        }

        .form-group input:focus {
            border-color: #4ECDC4;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            background: #4ECDC4;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .submit-btn:hover {
            background: #3ab0a8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 30px 0 25px;
            color: #999;
            font-size: 14px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e0e0e0;
        }

        .divider::before {
            margin-right: 15px;
        }

        .divider::after {
            margin-left: 15px;
        }

        .google-login {
            width: 100%;
            padding: 14px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
            color: #555;
            font-weight: 500;
        }

        .google-login:hover {
            border-color: #4285F4;
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.2);
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        @media (max-width: 768px) {
            .profile-modal-content {
                width: 90%;
                min-width: auto;
                padding: 40px 30px;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Загрузка карты...</div>

    <div class="language-switcher" onclick="toggleLanguage()" id="langBtn" title="Сменить язык / Change language">
        EN
    </div>

    <div class="profile-icon" onclick="openProfileModal()" title="Профиль / Profile">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
    </div>

    <div class="map-container" id="mapContainer">
        <svg id="worldMap" viewBox="0 0 1000 500" preserveAspectRatio="xMidYMid meet"></svg>
    </div>

    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()" title="Приблизить / Zoom In">+</button>
        <button class="zoom-btn" onclick="zoomOut()" title="Отдалить / Zoom Out">−</button>
        <button class="zoom-btn" onclick="resetZoom()" title="Сбросить / Reset">⟲</button>
    </div>

    <div class="info-panel" id="infoPanel">
        <h3 id="countryName"></h3>
        <p id="countryInfo"></p>
    </div>

    <!-- Модальное окно профиля -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-modal-content">
            <button class="close-modal" onclick="closeProfileModal()">&times;</button>

            <div class="form-header">
                <h2 id="formTitle" onclick="toggleAuthMode()">АВТОРИЗАЦИЯ</h2>
            </div>

            <form id="authForm" onsubmit="handleSubmit(event)">
                <div class="form-group">
                    <label for="email">Email или имя пользователя</label>
                    <input type="text" id="email" required>
                </div>

                <div class="form-group">
                    <label for="password">Пароль</label>
                    <input type="password" id="password" required>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">Авторизация</button>

                <div class="divider">или</div>

                <button type="button" class="google-login" onclick="googleLogin()">
                    <svg class="google-icon" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Войти через Google
                </button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <script>
        let currentLang = 'ru';
        let worldData;
        let svg, g, projection, path, zoom;
        let currentScale = 1;
        let currentTranslate = [0, 0];
        
        // ============ КОНФИГУРАЦИЯ API ============
        const API_URL = 'http://localhost:8000';  // Адрес твоего backend

        // ============ ПРОВЕРКА АВТОРИЗАЦИИ ============
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            const username = localStorage.getItem('username');

            if (token && username) {
                // Пользователь авторизован - показываем имя
                updateProfileIcon(username);
                return true;
            }
            return false;
        }

        function updateProfileIcon(username) {
            const profileIcon = document.querySelector('.profile-icon');
            profileIcon.innerHTML = `<div style="font-size: 12px; font-weight: 600; color: #2c3e50;">${username}</div>`;
            profileIcon.title = `Вы вошли как: ${username}`;
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('username');
            localStorage.removeItem('email');

            // Восстанавливаем иконку профиля
            const profileIcon = document.querySelector('.profile-icon');
            profileIcon.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>`;
            profileIcon.title = 'Profile';

            alert(currentLang === 'ru' ? 'Вы вышли из аккаунта' : 'You have logged out');
        }

        // ============ ОТКРЫТИЕ МОДАЛЬНОГО ОКНА ============
        function openProfileModal() {
            // Проверяем авторизацию
            if (checkAuth()) {
                const username = localStorage.getItem('username');
                const confirmLogout = confirm(
                    currentLang === 'ru' 
                        ? `Вы вошли как ${username}. Выйти?` 
                        : `Logged in as ${username}. Logout?`
                );

                if (confirmLogout) {
                    logout();
                }
                return;
            }

            // Если не авторизован - показываем форму
            document.getElementById('profileModal').classList.add('show');
            document.getElementById('mapContainer').classList.add('blurred');
        }

        function closeProfileModal() {
            document.getElementById('profileModal').classList.remove('show');
            document.getElementById('mapContainer').classList.remove('blurred');
        }

        // ============ ОБРАБОТКА ОТПРАВКИ ФОРМЫ ============
        async function handleSubmit(event) {
            event.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const submitBtn = document.getElementById('submitBtn');

            // Блокируем кнопку
            submitBtn.disabled = true;
            submitBtn.textContent = currentLang === 'ru' ? 'Загрузка...' : 'Loading...';

            try {
                if (isLoginMode) {
                    // ============ ЛОГИН ============
                    const response = await fetch(`${API_URL}/auth/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email_or_username: email,
                            password: password
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.detail || 'Ошибка авторизации');
                    }

                    // Сохраняем токен и данные пользователя
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('username', email.includes('@') ? email.split('@')[0] : email);

                    alert(currentLang === 'ru' ? 'Вы успешно вошли!' : 'Login successful!');
                    closeProfileModal();

                    // Обновляем интерфейс
                    checkAuth();

                } else {
                    // ============ РЕГИСТРАЦИЯ ============
                    const response = await fetch(`${API_URL}/auth/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: email,
                            username: email.includes('@') ? email.split('@')[0] : email,
                            password: password
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.detail || 'Ошибка регистрации');
                    }

                    alert(currentLang === 'ru' 
                        ? 'Регистрация успешна! Теперь войдите.' 
                        : 'Registration successful! Now login.');

                    // Переключаем на режим логина
                    toggleAuthMode();
                }

            } catch (error) {
                console.error('Error:', error);
                alert(currentLang === 'ru' 
                    ? `Ошибка: ${error.message}` 
                    : `Error: ${error.message}`);
            } finally {
                // Разблокируем кнопку
                submitBtn.disabled = false;
                submitBtn.textContent = isLoginMode 
                    ? (currentLang === 'ru' ? 'Авторизация' : 'Login')
                    : (currentLang === 'ru' ? 'Регистрация' : 'Sign Up');
            }
        }


        let isLoginMode = true;

        const countryNames = {
            ru: {
                'USA': 'США',
                'CAN': 'Канада',
                'MEX': 'Мексика',
                'BRA': 'Бразилия',
                'ARG': 'Аргентина',
                'CHL': 'Чили',
                'PER': 'Перу',
                'COL': 'Колумбия',
                'VEN': 'Венесуэла',
                'RUS': 'Россия',
                'CHN': 'Китай',
                'IND': 'Индия',
                'JPN': 'Япония',
                'KOR': 'Ю. Корея',
                'THA': 'Таиланд',
                'VNM': 'Вьетнам',
                'IDN': 'Индонезия',
                'AUS': 'Австралия',
                'NZL': 'Н. Зеландия',
                'DEU': 'Германия',
                'FRA': 'Франция',
                'GBR': 'Великобритания',
                'ITA': 'Италия',
                'ESP': 'Испания',
                'POL': 'Польша',
                'UKR': 'Украина',
                'ROU': 'Румыния',
                'NLD': 'Нидерланды',
                'BEL': 'Бельгия',
                'GRC': 'Греция',
                'PRT': 'Португалия',
                'SWE': 'Швеция',
                'NOR': 'Норвегия',
                'FIN': 'Финляндия',
                'DNK': 'Дания',
                'CHE': 'Швейцария',
                'AUT': 'Австрия',
                'TUR': 'Турция',
                'EGY': 'Египет',
                'ZAF': 'ЮАР',
                'NGA': 'Нигерия',
                'ETH': 'Эфиопия',
                'KEN': 'Кения',
                'DZA': 'Алжир',
                'MAR': 'Марокко',
                'SDN': 'Судан',
                'TZA': 'Танзания',
                'SAU': 'Саудовская Аравия',
                'IRN': 'Иран',
                'IRQ': 'Ирак',
                'PAK': 'Пакистан',
                'AFG': 'Афганистан',
                'KAZ': 'Казахстан',
                'UZB': 'Узбекистан',
                'MNG': 'Монголия',
                'ISR': 'Израиль',
                'JOR': 'Иордания',
                'SYR': 'Сирия',
                'LBN': 'Ливан'
            },
            en: {
                'USA': 'USA',
                'CAN': 'Canada',
                'MEX': 'Mexico',
                'BRA': 'Brazil',
                'ARG': 'Argentina',
                'CHL': 'Chile',
                'PER': 'Peru',
                'COL': 'Colombia',
                'VEN': 'Venezuela',
                'RUS': 'Russia',
                'CHN': 'China',
                'IND': 'India',
                'JPN': 'Japan',
                'KOR': 'S. Korea',
                'THA': 'Thailand',
                'VNM': 'Vietnam',
                'IDN': 'Indonesia',
                'AUS': 'Australia',
                'NZL': 'New Zealand',
                'DEU': 'Germany',
                'FRA': 'France',
                'GBR': 'UK',
                'ITA': 'Italy',
                'ESP': 'Spain',
                'POL': 'Poland',
                'UKR': 'Ukraine',
                'ROU': 'Romania',
                'NLD': 'Netherlands',
                'BEL': 'Belgium',
                'GRC': 'Greece',
                'PRT': 'Portugal',
                'SWE': 'Sweden',
                'NOR': 'Norway',
                'FIN': 'Finland',
                'DNK': 'Denmark',
                'CHE': 'Switzerland',
                'AUT': 'Austria',
                'TUR': 'Turkey',
                'EGY': 'Egypt',
                'ZAF': 'South Africa',
                'NGA': 'Nigeria',
                'ETH': 'Ethiopia',
                'KEN': 'Kenya',
                'DZA': 'Algeria',
                'MAR': 'Morocco',
                'SDN': 'Sudan',
                'TZA': 'Tanzania',
                'SAU': 'Saudi Arabia',
                'IRN': 'Iran',
                'IRQ': 'Iraq',
                'PAK': 'Pakistan',
                'AFG': 'Afghanistan',
                'KAZ': 'Kazakhstan',
                'UZB': 'Uzbekistan',
                'MNG': 'Mongolia',
                'ISR': 'Israel',
                'JOR': 'Jordan',
                'SYR': 'Syria',
                'LBN': 'Lebanon'
            }
        };

        const countryInfo = {
            ru: {
                'USA': 'Третья по площади страна мира',
                'CAN': 'Вторая по площади страна',
                'MEX': 'Страна майя и ацтеков',
                'BRA': 'Крупнейшая страна Южной Америки',
                'ARG': 'Страна танго и футбола',
                'RUS': 'Самая большая страна в мире',
                'CHN': 'Самая населенная страна',
                'IND': 'Вторая по населению страна',
                'JPN': 'Страна восходящего солнца',
                'AUS': 'Страна-континент',
                'DEU': 'Экономический центр Европы',
                'FRA': 'Страна моды и культуры',
                'GBR': 'Островное королевство',
                'ITA': 'Родина Ренессанса',
                'ESP': 'Страна фламенко',
                'TUR': 'Мост между Европой и Азией',
                'EGY': 'Страна пирамид',
                'ZAF': 'Радужная нация',
                'KAZ': 'Крупнейшая страна Центральной Азии'
            },
            en: {
                'USA': 'Third largest country in the world',
                'CAN': 'Second largest country',
                'MEX': 'Land of Maya and Aztecs',
                'BRA': 'Largest South American country',
                'ARG': 'Land of tango and football',
                'RUS': 'Largest country in the world',
                'CHN': 'Most populous country',
                'IND': 'Second most populous country',
                'JPN': 'Land of the rising sun',
                'AUS': 'Island continent',
                'DEU': 'Economic center of Europe',
                'FRA': 'Country of fashion and culture',
                'GBR': 'Island kingdom',
                'ITA': 'Birthplace of Renaissance',
                'ESP': 'Land of flamenco',
                'TUR': 'Bridge between Europe and Asia',
                'EGY': 'Land of pyramids',
                'ZAF': 'Rainbow nation',
                'KAZ': 'Largest Central Asian country'
            }
        };

        const colorScale = d3.scaleOrdinal()
            .range([
                '#FF6B6B', '#4ECDC4', '#95E1D3', '#F38181', '#AA96DA',
                '#FCBAD3', '#FFFFD2', '#C7CEEA', '#B5EAD7', '#FFD93D',
                '#6BCB77', '#E23E57', '#88D498', '#3EC1D3', '#F6F7D7',
                '#FF7E67', '#FDCB9E', '#C490E4', '#A0E7E5', '#FFC93C',
                '#F77E21', '#667eea', '#f093fb', '#4facfe', '#43e97b'
            ]);

        // Функции модального окна профиля
        

        

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;

            const formTitle = document.getElementById('formTitle');
            const submitBtn = document.getElementById('submitBtn');

            if (isLoginMode) {
                formTitle.textContent = currentLang === 'ru' ? 'АВТОРИЗАЦИЯ' : 'LOGIN';
                submitBtn.textContent = currentLang === 'ru' ? 'Авторизация' : 'Login';
            } else {
                formTitle.textContent = currentLang === 'ru' ? 'РЕГИСТРАЦИЯ' : 'SIGN UP';
                submitBtn.textContent = currentLang === 'ru' ? 'Регистрация' : 'Sign Up';
            }
        }

        
        function googleLogin() {
            alert(currentLang === 'ru' ? 'Вход через Google...' : 'Google login...');
        }

        // Закрытие модального окна при клике вне его
        document.getElementById('profileModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeProfileModal();
            }
        });

        async function loadMap() {
            try {
                const response = await fetch('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
                const world = await response.json();
                worldData = topojson.feature(world, world.objects.countries);

                renderMap();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Error loading map:', error);
                document.getElementById('loading').textContent = 'Ошибка загрузки карты';
            }
        }

        function renderMap() {
            svg = d3.select('#worldMap');
            svg.selectAll('*').remove();

            const width = 1000;
            const height = 500;

            projection = d3.geoNaturalEarth1()
                .scale(160)
                .translate([width / 2, height / 2]);

            path = d3.geoPath().projection(projection);

            svg.append('rect')
                .attr('width', width)
                .attr('height', height)
                .attr('fill', '#1a5f7a');

            g = svg.append('g');

            zoom = d3.zoom()
                .scaleExtent([1, 8])
                .translateExtent([[0, 0], [width, height]])
                .extent([[0, 0], [width, height]])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                    currentScale = event.transform.k;
                    currentTranslate = [event.transform.x, event.transform.y];
                });

            svg.call(zoom);

            g.selectAll('path')
                .data(worldData.features)
                .enter()
                .append('path')
                .attr('class', 'country-path')
                .attr('d', path)
                .attr('fill', (d, i) => colorScale(i))
                .on('mouseenter', function(event, d) {
                    showInfo(d);
                })
                .on('mouseleave', hideInfo)
                .on('click', function(event, d) {
                    const code = d.id;
                    const name = countryNames[currentLang][code] || d.properties.name;
                    const info = countryInfo[currentLang][code] || 'Информация недоступна';
                    alert(`${name}\n\n${info}`);
                });

            g.selectAll('text')
                .data(worldData.features)
                .enter()
                .append('text')
                .attr('class', 'country-label')
                .attr('transform', d => {
                    const centroid = path.centroid(d);
                    return `translate(${centroid})`;
                })
                .text(d => {
                    const code = d.id;
                    const name = countryNames[currentLang][code] || '';
                    const area = d3.geoArea(d);

                    if (area < 0.01) return '';

                    if (area < 0.03 && name.length > 8) {
                        return name.substring(0, 6) + '.';
                    }

                    return name;
                })
                .attr('font-size', d => {
                    const area = d3.geoArea(d);
                    if (area > 0.15) return '16px';
                    if (area > 0.08) return '14px';
                    if (area > 0.04) return '12px';
                    if (area > 0.02) return '10px';
                    if (area > 0.01) return '8px';
                    return '0px';
                })
                .attr('font-weight', d => {
                    const area = d3.geoArea(d);
                    return area > 0.1 ? '700' : '600';
                });
        }

        function showInfo(d) {
            const code = d.id;
            const name = countryNames[currentLang][code] || d.properties.name;
            const info = countryInfo[currentLang][code] || (currentLang === 'ru' ? 'Информация недоступна' : 'No information available');

            document.getElementById('countryName').textContent = name;
            document.getElementById('countryInfo').textContent = info;
            document.getElementById('infoPanel').classList.add('show');
        }

        function hideInfo() {
            document.getElementById('infoPanel').classList.remove('show');
        }

        function toggleLanguage() {
            currentLang = currentLang === 'ru' ? 'en' : 'ru';
            const langBtn = document.getElementById('langBtn');
            langBtn.textContent = currentLang === 'en' ? 'RU' : 'EN';

            // Обновляем текст в модальном окне
            const formTitle = document.getElementById('formTitle');
            const submitBtn = document.getElementById('submitBtn');

            if (isLoginMode) {
                formTitle.textContent = currentLang === 'ru' ? 'АВТОРИЗАЦИЯ' : 'LOGIN';
                submitBtn.textContent = currentLang === 'ru' ? 'Авторизация' : 'Login';
            } else {
                formTitle.textContent = currentLang === 'ru' ? 'РЕГИСТРАЦИЯ' : 'SIGN UP';
                submitBtn.textContent = currentLang === 'ru' ? 'Регистрация' : 'Sign Up';
            }

            if (document.getElementById('loading').style.display === 'none') {
                g.selectAll('text').remove();

                g.selectAll('text')
                    .data(worldData.features)
                    .enter()
                    .append('text')
                    .attr('class', 'country-label')
                    .attr('transform', d => {
                        const centroid = path.centroid(d);
                        return `translate(${centroid})`;
                    })
                    .text(d => {
                        const code = d.id;
                        const name = countryNames[currentLang][code] || '';
                        const area = d3.geoArea(d);

                        if (area < 0.01) return '';

                        if (area < 0.03 && name.length > 8) {
                            return name.substring(0, 6) + '.';
                        }

                        return name;
                    })
                    .attr('font-size', d => {
                        const area = d3.geoArea(d);
                        if (area > 0.15) return '16px';
                        if (area > 0.08) return '14px';
                        if (area > 0.04) return '12px';
                        if (area > 0.02) return '10px';
                        if (area > 0.01) return '8px';
                        return '0px';
                    })
                    .attr('font-weight', d => {
                        const area = d3.geoArea(d);
                        return area > 0.1 ? '700' : '600';
                    });
            }
        }

        function zoomIn() {
            const newScale = Math.min(currentScale * 1.5, 8);
            svg.transition()
                .duration(300)
                .call(zoom.scaleTo, newScale);
        }

        function zoomOut() {
            const newScale = Math.max(currentScale / 1.5, 1);
            svg.transition()
                .duration(300)
                .call(zoom.scaleTo, newScale);
        }

        function resetZoom() {
            svg.transition()
                .duration(300)
                .call(zoom.transform, d3.zoomIdentity);
        }

        loadMap();
        checkAuth();  // Проверяем авторизацию при загрузке
    </script>
</body>
</html>